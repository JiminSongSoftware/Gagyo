name: EAS Submit

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to submit'
        required: true
        type: choice
        options: [ios, android, all]
      version:
        description: 'App version to submit (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  validate:
    name: Validate Before Submit
    runs-on: ubuntu-latest
    outputs:
      can-proceed: ${{ steps.validation.outputs.can-proceed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run validation
        id: validation
        run: |
          echo "Validating version ${{ github.event.inputs.version }}..."

          # Check version matches app.json
          APP_VERSION=$(jq -r '.expo.version' app.json)
          if [ "$APP_VERSION" != "${{ github.event.inputs.version }}" ]; then
            echo "❌ Version mismatch: app.json has $APP_VERSION but input is ${{ github.event.inputs.version }}"
            echo "can-proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Run tests
          bun run test --passWithNoTests
          bun run lint
          bun run typecheck

          echo "can-proceed=true" >> $GITHUB_OUTPUT

  submit-ios:
    name: Submit to TestFlight
    runs-on: ubuntu-latest
    environment: production
    needs: validate
    if: ${{ github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'all' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Submit to App Store Connect
        run: eas submit --platform ios --latest --non-interactive
        env:
          EXPO_APPLE_ID: ${{ secrets.APPLE_ID }}
          EXPO_ASC_APP_ID: ${{ secrets.ASC_APP_ID }}
          EXPO_APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Notify submission success
        run: echo "✅ iOS app submitted to TestFlight successfully"

  submit-android:
    name: Submit to Play Store
    runs-on: ubuntu-latest
    environment: production
    needs: validate
    if: ${{ github.event.inputs.platform == 'android' || github.event.inputs.platform == 'all' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Create service account key file
        run: |
          echo "${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}" | base64 -d > google-services-key.json

      - name: Submit to Play Store
        run: eas submit --platform android --latest --non-interactive

      - name: Clean up service account key
        run: rm -f google-services-key.json

      - name: Notify submission success
        run: echo "✅ Android app submitted to Play Store Internal Testing successfully"
