# Service Architecture

This document defines the service boundaries, Edge Function specifications, API contracts, real-time subscription patterns, and observability standards for Gagyo.

---

## Architecture Overview

Gagyo follows a serverless-first architecture using Supabase as the backend platform:

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Expo React Native App                       │
├─────────────────────────────────────────────────────────────────────┤
│  Jotai Atoms  │  Zustand Stores  │  Supabase Client  │  i18n       │
└───────┬───────┴────────┬─────────┴────────┬──────────┴─────────────┘
        │                │                  │
        ▼                ▼                  ▼
┌───────────────────────────────────────────────────────────────────┐
│                      Supabase Platform                             │
├───────────────┬───────────────┬───────────────┬───────────────────┤
│   PostgREST   │   Realtime    │ Edge Functions│   Storage         │
│   (REST API)  │   (WebSocket) │   (Deno)      │   (Files)         │
├───────────────┴───────────────┴───────────────┴───────────────────┤
│                       PostgreSQL Database                          │
│                    (with RLS Policies)                             │
└───────────────────────────────────────────────────────────────────┘
        │                                    │
        ▼                                    ▼
┌───────────────────┐              ┌───────────────────┐
│   Expo Push       │              │   Sentry          │
│   Notification    │              │   PostHog         │
│   Service         │              │   (Observability) │
└───────────────────┘              └───────────────────┘
```

---

## Service Boundaries

### 1. PostgREST (REST API)

Standard CRUD operations on all tables, automatically generated by Supabase.

**Responsibilities**:
- Create, read, update, delete operations on all entities
- Query filtering using PostgREST query syntax
- Batch operations via transaction support

**Security**:
- All requests require valid JWT (anon key or authenticated)
- RLS policies enforce tenant isolation and role-based access
- No direct table access without RLS bypass

---

### 2. Realtime Service

WebSocket-based real-time subscriptions for live updates.

**Responsibilities**:
- Broadcast new messages to conversation participants
- Broadcast notification events to users
- Broadcast pastoral journal status changes

**Channels**:
| Channel Pattern | Description | Access Control |
|-----------------|-------------|----------------|
| `tenant:{tenant_id}:conversations` | All conversation updates in tenant | Tenant membership required |
| `conversation:{conversation_id}` | Messages in specific conversation | Conversation participant or membership role access |
| `user:{user_id}:notifications` | User's personal notifications | User identity match |
| `tenant:{tenant_id}:pastoral_journals` | Journal status updates | Role: zone_leader, pastor, admin |

---

### 3. Edge Functions (Deno)

Serverless functions for complex business logic that cannot be expressed in SQL or RLS.

---

## Edge Function Specifications

### send-push-notification

Sends push notifications to users via Expo Push Notification Service.

| Property | Value |
|----------|-------|
| **Trigger** | HTTP POST from database webhooks or other Edge Functions |
| **Authentication** | Service role key (internal only) |
| **Rate Limit** | 1000 requests/minute per tenant |

**Request Schema**:
```typescript
interface SendPushNotificationRequest {
  tenant_id: string;
  user_ids: string[];  // Target users
  notification: {
    type: NotificationType;
    title: string;
    body: string;
    data?: Record<string, unknown>;  // Deep link payload
  };
}
```

**Response Schema**:
```typescript
interface SendPushNotificationResponse {
  success: boolean;
  sent_count: number;
  failed_tokens: string[];  // Tokens that failed/expired
  errors?: Array<{
    user_id: string;
    error: string;
  }>;
}
```

**Error Responses**:
| Status | Code | Description |
|--------|------|-------------|
| 400 | `INVALID_REQUEST` | Missing or invalid required fields |
| 401 | `UNAUTHORIZED` | Invalid or missing service role key |
| 429 | `RATE_LIMITED` | Too many requests |
| 500 | `PUSH_SERVICE_ERROR` | Expo Push Service unavailable |

**Implementation Notes**:
- Batch notifications in groups of 100 (Expo limit)
- Remove expired tokens from `device_tokens` table
- Log all notifications to `notifications` table
- Respect user notification preferences (future)

---

### process-pastoral-journal

Handles pastoral journal workflow state transitions and triggers notifications.

| Property | Value |
|----------|-------|
| **Trigger** | Database webhook on `pastoral_journals` INSERT/UPDATE |
| **Authentication** | Service role key (internal only) |
| **Rate Limit** | 100 requests/minute per tenant |

**Request Schema** (from webhook):
```typescript
interface PastoralJournalWebhookPayload {
  type: 'INSERT' | 'UPDATE';
  table: 'pastoral_journals';
  record: PastoralJournal;
  old_record?: PastoralJournal;
}
```

**Workflow Logic**:
```
if (old_record?.status === 'draft' && record.status === 'submitted') {
  // Notify zone leader
  findZoneLeader(record.small_group_id)
  sendPushNotification(zone_leader, 'pastoral_journal_submitted')
}

if (old_record?.status === 'submitted' && record.status === 'zone_reviewed') {
  // Notify pastors
  findPastors(record.tenant_id)
  sendPushNotification(pastors, 'pastoral_journal_forwarded')
}

if (old_record?.status === 'zone_reviewed' && record.status === 'pastor_confirmed') {
  // Notify original author
  sendPushNotification(record.author_id, 'pastoral_journal_confirmed')
}
```

**Response Schema**:
```typescript
interface ProcessPastoralJournalResponse {
  success: boolean;
  notifications_sent: number;
  workflow_state: PastoralJournalStatus;
}
```

---

### generate-prayer-analytics

Computes prayer card statistics for various scopes (individual, small group, church-wide).

| Property | Value |
|----------|-------|
| **Trigger** | HTTP GET from client or scheduled cron |
| **Authentication** | User JWT (scoped to tenant) |
| **Rate Limit** | 60 requests/minute per user |
| **Caching** | Results cached for 5 minutes |

**Request Schema**:
```typescript
interface GeneratePrayerAnalyticsRequest {
  tenant_id: string;
  scope: 'individual' | 'small_group' | 'church_wide';
  scope_id?: string;  // membership_id for individual, small_group_id for small_group
  period: 'week' | 'month' | 'year' | 'all_time';
}
```

**Response Schema**:
```typescript
interface PrayerAnalyticsResponse {
  scope: string;
  scope_id?: string;
  period: {
    start: string;  // ISO date
    end: string;    // ISO date
  };
  metrics: {
    total_prayers: number;
    answered_prayers: number;
    answer_rate: number;  // 0-1 decimal
    prayers_this_period: number;
    answered_this_period: number;
  };
  trends?: {
    previous_period_answer_rate: number;
    change: number;  // Percentage change
  };
}
```

**Error Responses**:
| Status | Code | Description |
|--------|------|-------------|
| 400 | `INVALID_SCOPE` | Invalid scope or scope_id combination |
| 401 | `UNAUTHORIZED` | Invalid JWT or tenant access denied |
| 403 | `FORBIDDEN` | User lacks permission for requested scope |

---

### handle-message-sent

Processes new messages, handles Event Chat exclusions, and triggers notifications.

| Property | Value |
|----------|-------|
| **Trigger** | Database webhook on `messages` INSERT |
| **Authentication** | Service role key (internal only) |
| **Rate Limit** | 500 requests/minute per tenant |

**Request Schema** (from webhook):
```typescript
interface MessageWebhookPayload {
  type: 'INSERT';
  table: 'messages';
  record: Message;
}
```

**Processing Logic**:
1. Determine notification recipients based on conversation type
2. If `is_event_chat = true`, filter out excluded users
3. Exclude message sender from notifications
4. Send push notifications to remaining recipients
5. Update `conversation.updated_at` for sorting

**Response Schema**:
```typescript
interface HandleMessageSentResponse {
  success: boolean;
  recipients_notified: number;
  excluded_users: number;  // Event Chat exclusions applied
}
```

---

## Real-Time Subscription Patterns

### Chat Message Subscriptions

```typescript
// Subscribe to messages in a specific conversation
const subscription = supabase
  .channel(`conversation:${conversationId}`)
  .on(
    'postgres_changes',
    {
      event: 'INSERT',
      schema: 'public',
      table: 'messages',
      filter: `conversation_id=eq.${conversationId}`
    },
    (payload) => {
      // Update local state with new message
      addMessage(payload.new as Message);
    }
  )
  .on(
    'postgres_changes',
    {
      event: 'UPDATE',
      schema: 'public',
      table: 'messages',
      filter: `conversation_id=eq.${conversationId}`
    },
    (payload) => {
      // Handle message edits or soft deletes
      updateMessage(payload.new as Message);
    }
  )
  .subscribe();
```

### Notification Subscriptions

```typescript
// Subscribe to user's notifications
const subscription = supabase
  .channel(`user:${userId}:notifications`)
  .on(
    'postgres_changes',
    {
      event: 'INSERT',
      schema: 'public',
      table: 'notifications',
      filter: `user_id=eq.${userId}`
    },
    (payload) => {
      // Show in-app notification
      showNotification(payload.new as Notification);
    }
  )
  .subscribe();
```

### Pastoral Journal Status Subscriptions

```typescript
// Subscribe to journal updates (for zone leaders/pastors)
const subscription = supabase
  .channel(`tenant:${tenantId}:pastoral_journals`)
  .on(
    'postgres_changes',
    {
      event: 'UPDATE',
      schema: 'public',
      table: 'pastoral_journals',
      filter: `tenant_id=eq.${tenantId}`
    },
    (payload) => {
      // Update journal status in UI
      updateJournalStatus(payload.new as PastoralJournal);
    }
  )
  .subscribe();
```

---

## Observability

### Sentry Error Tracking

**Event Taxonomy**:
| Event Category | Events | Severity |
|----------------|--------|----------|
| Auth | `auth.login_failed`, `auth.token_expired`, `auth.session_error` | Warning |
| Network | `network.request_failed`, `network.timeout`, `network.offline` | Error |
| Database | `db.query_error`, `db.rls_violation`, `db.connection_lost` | Error |
| Push | `push.send_failed`, `push.token_invalid`, `push.service_error` | Warning |
| Realtime | `realtime.subscription_error`, `realtime.connection_lost` | Warning |
| UI | `ui.render_error`, `ui.navigation_error` | Error |

**Context Tags**:
```typescript
Sentry.setTags({
  tenant_id: currentTenantId,
  user_role: userRole,
  app_version: Constants.expoConfig?.version,
  locale: userLocale,
});
```

**Breadcrumbs**:
- Navigation events (screen changes)
- User actions (button clicks, form submissions)
- Network requests (API calls)
- State changes (tenant switch, auth state)

---

### PostHog Analytics

**Event Taxonomy**:
| Category | Event Name | Properties |
|----------|------------|------------|
| Auth | `user_signed_in` | `{ method, tenant_id }` |
| Auth | `user_signed_out` | `{ tenant_id }` |
| Auth | `tenant_switched` | `{ from_tenant, to_tenant }` |
| Chat | `message_sent` | `{ conversation_type, has_attachment, is_event_chat }` |
| Chat | `conversation_opened` | `{ conversation_type, message_count }` |
| Prayer | `prayer_card_created` | `{ recipient_scope, has_attachment }` |
| Prayer | `prayer_answered` | `{ days_since_created }` |
| Pastoral | `journal_submitted` | `{ week_number, content_length }` |
| Pastoral | `journal_reviewed` | `{ reviewer_role, days_since_submitted }` |
| Settings | `locale_changed` | `{ from_locale, to_locale }` |
| Settings | `notification_toggled` | `{ type, enabled }` |

**User Properties**:
```typescript
posthog.identify(userId, {
  tenant_count: membershipCount,
  primary_role: highestRole,
  locale: userLocale,
  created_at: user.created_at,
});
```

**Group Analytics**:
```typescript
posthog.group('tenant', tenantId, {
  name: tenant.name,
  member_count: memberCount,
  created_at: tenant.created_at,
});
```

---

### Edge Function Logging

**Log Format** (structured JSON):
```typescript
interface EdgeFunctionLog {
  timestamp: string;
  level: 'debug' | 'info' | 'warn' | 'error';
  function_name: string;
  tenant_id?: string;
  user_id?: string;
  request_id: string;
  duration_ms?: number;
  message: string;
  metadata?: Record<string, unknown>;
}
```

**Example**:
```json
{
  "timestamp": "2024-01-04T12:00:00.000Z",
  "level": "info",
  "function_name": "send-push-notification",
  "tenant_id": "abc-123",
  "request_id": "req-xyz-789",
  "duration_ms": 245,
  "message": "Push notifications sent successfully",
  "metadata": {
    "user_count": 15,
    "sent_count": 14,
    "failed_count": 1
  }
}
```

---

## Caching Strategy

### Client-Side Caching

| Data Type | Strategy | TTL | Invalidation |
|-----------|----------|-----|--------------|
| User profile | Cache-first | 5 min | On profile update |
| Tenant list | Cache-first | 10 min | On membership change |
| Conversation list | Stale-while-revalidate | 1 min | On new message |
| Message history | Cache-first, paginated | 5 min | On real-time update |
| Prayer card list | Stale-while-revalidate | 2 min | On create/answer |
| Prayer analytics | Cache-first | 5 min | On generate request |

### Cache Implementation

```typescript
// Using React Query / TanStack Query patterns with Jotai
const conversationsAtom = atomWithQuery((get) => ({
  queryKey: ['conversations', get(currentTenantIdAtom)],
  queryFn: () => fetchConversations(get(currentTenantIdAtom)),
  staleTime: 60 * 1000,  // 1 minute
  cacheTime: 5 * 60 * 1000,  // 5 minutes
}));
```

---

## Security Considerations

### JWT Claims

All authenticated requests include a JWT with the following claims:

```typescript
interface JWTClaims {
  sub: string;           // User ID (from auth.users)
  email?: string;        // User email
  role: 'authenticated'; // Supabase role
  aud: string;           // Audience
  exp: number;           // Expiration timestamp
  iat: number;           // Issued at timestamp

  // Custom claims (set via auth hooks)
  app_metadata?: {
    provider: string;
  };
  user_metadata?: {
    display_name?: string;
    avatar_url?: string;
  };
}
```

### Request Validation

All Edge Functions must:
1. Validate request body against schema
2. Verify JWT signature and expiration
3. Check tenant access (user has membership)
4. Check role-based permissions where applicable
5. Sanitize all user input
6. Rate limit by user/tenant

### Secrets Management

| Secret | Location | Access |
|--------|----------|--------|
| Supabase URL | Environment variable | All Edge Functions |
| Supabase Anon Key | Environment variable | Client |
| Supabase Service Role Key | Environment variable | Edge Functions only |
| Expo Push Access Token | Environment variable | send-push-notification only |
| Sentry DSN | Environment variable | Client & Edge Functions |
| PostHog API Key | Environment variable | Client only |

---

## API Versioning

Currently, all APIs are v1 (implicit). Future breaking changes will use:
- URL path versioning for REST: `/v2/...`
- Channel naming for Realtime: `v2:tenant:{id}:...`
- Function naming for Edge Functions: `v2-send-push-notification`

---

## Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2024-01-04 | Claude | Initial architecture specification |
